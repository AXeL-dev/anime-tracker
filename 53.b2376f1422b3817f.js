"use strict";(self.webpackChunkanime_tracker=self.webpackChunkanime_tracker||[]).push([[53],{3053:(Y,g,t)=>{t.r(g),t.d(g,{BackgroundModule:()=>x});var f=t(9808),u=t(5056),m=t(655),p=t(5698),v=t(3470),b=t(4056),C=t(5360),k=t(2340),y=t(5491),n=t(1223),B=t(4071),E=t(452),M=t(3631),A=t(657),L=t(8604),T=t(1942),R=t(9744);const w=[{path:"**",component:(()=>{class s{constructor(e,o,a,r,d,i,c,l){this.browser=e,this.settings=o,this.router=a,this.debug=r,this.animeProvider=d,this.favoriteAnimes=i,this.viewedEpisodes=c,this.notifications=l,this.checkedEpisodes=[],this.badgeCount=0}ngOnInit(){this.debug.enable(!0),this.browser.isWebExtension||!k.N.production?this.init():this.router.navigate(["/"])}init(){var e,o;this.browser.setBadgeColors("#666","#fff"),this.debug.log({rate:this.settings.autoCheckRate,notifications:this.settings.enableNotifications?"on":"off"}),this.autoCheckLoop(),null===(e=this.browser.api)||void 0===e||e.notifications.onClicked.addListener(a=>{var r;this.debug.log("Notification clicked:",a);const[d,i]=a.split("::").map(c=>+c);if(i>=0){const c=this.checkedEpisodes[i],l=null===(r=c.streamLinks[0])||void 0===r?void 0:r.url;(null==l?void 0:l.length)&&(this.browser.createTab(l),this.viewedEpisodes.add(c))}}),null===(o=this.browser.api)||void 0===o||o.runtime.onMessage.addListener((a,r,d)=>{this.debug.log("Handle message:",a);let i=null;switch(a.message){case"getNotifications":i=this.notifications.get();break;case"markNotificationsAsRead":i=this.notifications.markAllAsRead();break;default:this.debug.warn(`Cannot handle "${a.message}" message!`)}this.debug.log("response:",i),d({response:i})})}autoCheckLoop(){setTimeout(()=>(0,m.mG)(this,void 0,void 0,function*(){const[e,o]=yield this.getRecentEpisodesCount();this.debug.log("Recent episodes count:",e),e>0&&((yield this.browser.getBadgeText()).length?this.badgeCount+=e:this.badgeCount=e,this.debug.log("Total count:",this.badgeCount),this.browser.setBadgeText(this.badgeCount),this.settings.enableNotifications&&o.forEach(r=>{this.notifications.push(r.message,C.k.Success);const d=(0,v.zO)().getTime()+"::"+r.episode.index;this.browser.sendNotification(r.message,d)})),yield this.settings.refresh(),this.autoCheckLoop()}),60*this.settings.autoCheckRate*1e3)}getRecentEpisodesCount(){return new Promise((e,o)=>(0,m.mG)(this,void 0,void 0,function*(){let a=0,r=[];const d=yield this.animeProvider.getLatestEpisodes(!0).pipe((0,p.q)(1)).toPromise();this.debug.log("Latest episodes:",d),this.debug.log("Checked episodes:",this.checkedEpisodes),yield this.viewedEpisodes.refresh(),yield this.favoriteAnimes.refresh(),d.forEach(i=>{!this.isAlreadyChecked(i)&&i.releaseDate&&(0,v.GW)(new Date(i.releaseDate))&&!this.viewedEpisodes.isViewed(i)&&this.favoriteAnimes.isFavorite(i.anime.title)&&this.hasMatchingSubtitles(i)&&(r.push({message:`${i.anime.title} ${i.number} released!`,episode:{index:a}}),a++,this.checkedEpisodes.push(i))}),e([a,r])}))}hasMatchingSubtitles(e){return this.settings.preferredSubtitles===y.B.Any||!!e.streamLinks.find(o=>o.lang.toLowerCase()===this.settings.preferredSubtitles.toLowerCase())}isAlreadyChecked(e){return!!this.checkedEpisodes.find(o=>(0,b.T0)(o.anime.title,e.anime.title,this.settings.episodeSimilarityDegree)&&o.number===e.number)}}return s.\u0275fac=function(e){return new(e||s)(n.Y36(B.q),n.Y36(E.g),n.Y36(u.F0),n.Y36(M.r),n.Y36(A._),n.Y36(L.S),n.Y36(T.z),n.Y36(R.T))},s.\u0275cmp=n.Xpm({type:s,selectors:[["app-main"]],decls:0,vars:0,template:function(e,o){},styles:[""]}),s})()}];let S=(()=>{class s{}return s.\u0275fac=function(e){return new(e||s)},s.\u0275mod=n.oAB({type:s}),s.\u0275inj=n.cJS({imports:[[u.Bz.forChild(w)],u.Bz]}),s})(),x=(()=>{class s{}return s.\u0275fac=function(e){return new(e||s)},s.\u0275mod=n.oAB({type:s}),s.\u0275inj=n.cJS({imports:[[f.ez,S]]}),s})()}}]);