(self.webpackChunkanime_tracker=self.webpackChunkanime_tracker||[]).push([[508],{2508:function(e,t,s){"use strict";s.r(t),s.d(t,{BackgroundModule:function(){return E}});var i=s(8583),o=s(5263),n=s(4762),a=s(5257),r=s(3470),d=s(4056),h=s(5360),c=s(2340),u=s(5491),l=s(639),g=s(4071),p=s(452),f=s(3631),m=s(961),b=s(8604),k=s(1942),w=s(9744);const v=[{path:"**",component:(()=>{class e{constructor(e,t,s,i,o,n,a,r){this.browser=e,this.settings=t,this.router=s,this.debug=i,this.animeProvider=o,this.favoriteAnimes=n,this.viewedEpisodes=a,this.notifications=r,this.checkedEpisodes=[],this.badgeCount=0}ngOnInit(){this.debug.enable(!0),this.browser.isWebExtension||!c.N.production?this.init():this.router.navigate(["/"])}init(){var e,t;this.browser.setBadgeColors("#666","#fff"),this.debug.log({rate:this.settings.autoCheckRate,notifications:this.settings.enableNotifications?"on":"off"}),this.autoCheckLoop(),null===(e=this.browser.api)||void 0===e||e.notifications.onClicked.addListener(e=>{var t;this.debug.log("Notification clicked:",e);const[s,i]=e.split("::").map(e=>+e);if(i>=0){const e=this.checkedEpisodes[i],s=null===(t=e.streamLinks[0])||void 0===t?void 0:t.url;(null==s?void 0:s.length)&&(this.browser.createTab(s),this.viewedEpisodes.add(e))}}),null===(t=this.browser.api)||void 0===t||t.runtime.onMessage.addListener((e,t,s)=>{this.debug.log("Handle message:",e);let i=null;switch(e.message){case"getNotifications":i=this.notifications.get();break;case"markNotificationsAsRead":i=this.notifications.markAllAsRead();break;default:this.debug.warn(`Cannot handle "${e.message}" message!`)}this.debug.log("response:",i),s({response:i})})}autoCheckLoop(){setTimeout(()=>(0,n.mG)(this,void 0,void 0,function*(){const[e,t]=yield this.getRecentEpisodesCount();this.debug.log("Recent episodes count:",e),e>0&&((yield this.browser.getBadgeText()).length?this.badgeCount+=e:this.badgeCount=e,this.debug.log("Total count:",this.badgeCount),this.browser.setBadgeText(this.badgeCount),this.settings.enableNotifications&&t.forEach(e=>{this.notifications.push(e.message,h.k.Success);const t=(0,r.zO)().getTime()+"::"+e.episode.index;this.browser.sendNotification(e.message,t)})),yield this.settings.refresh(),this.autoCheckLoop()}),60*this.settings.autoCheckRate*1e3)}getRecentEpisodesCount(){return new Promise((e,t)=>(0,n.mG)(this,void 0,void 0,function*(){let t=0,s=[];const i=yield this.animeProvider.getLatestEpisodes(!0).pipe((0,a.q)(1)).toPromise();this.debug.log("Latest episodes:",i),this.debug.log("Checked episodes:",this.checkedEpisodes),yield this.viewedEpisodes.refresh(),yield this.favoriteAnimes.refresh(),i.forEach(e=>{!this.isAlreadyChecked(e)&&e.releaseDate&&(0,r.GW)(new Date(e.releaseDate))&&!this.viewedEpisodes.isViewed(e)&&this.favoriteAnimes.isFavorite(e.anime.title)&&this.hasMatchingSubtitles(e)&&(s.push({message:`${e.anime.title} ${e.number} released!`,episode:{index:t}}),t++,this.checkedEpisodes.push(e))}),e([t,s])}))}hasMatchingSubtitles(e){return this.settings.preferredSubtitles===u.B.Any||!!e.streamLinks.find(e=>e.lang.toLowerCase()===this.settings.preferredSubtitles.toLowerCase())}isAlreadyChecked(e){return!!this.checkedEpisodes.find(t=>(0,d.T0)(t.anime.title,e.anime.title,this.settings.episodeSimilarityDegree)&&t.number===e.number)}}return e.\u0275fac=function(t){return new(t||e)(l.Y36(g.q),l.Y36(p.g),l.Y36(o.F0),l.Y36(f.r),l.Y36(m._),l.Y36(b.S),l.Y36(k.z),l.Y36(w.T))},e.\u0275cmp=l.Xpm({type:e,selectors:[["app-main"]],decls:0,vars:0,template:function(e,t){},styles:[""]}),e})()}];let C=(()=>{class e{}return e.\u0275fac=function(t){return new(t||e)},e.\u0275mod=l.oAB({type:e}),e.\u0275inj=l.cJS({imports:[[o.Bz.forChild(v)],o.Bz]}),e})(),E=(()=>{class e{}return e.\u0275fac=function(t){return new(t||e)},e.\u0275mod=l.oAB({type:e}),e.\u0275inj=l.cJS({imports:[[i.ez,C]]}),e})()}}]);